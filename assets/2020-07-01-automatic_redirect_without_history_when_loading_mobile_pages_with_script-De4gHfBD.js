import{_ as d}from"./ValaxyMain.vue_vue_type_style_index_0_lang-BWN6FZjJ.js";import{f as h,w as t,e as m,A as g,ag as u,o as f,a as l,H as e,U as o}from"./app-O6veFoRw.js";import"./YunComment.vue_vue_type_style_index_0_lang-BdmCVZ97.js";import"./index-C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-6OskRlK9.js";import"./post-CxZOEfth.js";const L={__name:"2020-07-01-automatic_redirect_without_history_when_loading_mobile_pages_with_script",setup(w,{expose:c}){const a=JSON.parse('{"title":"移动端页面加载时使用脚本自动跳转不会产生历史记录","description":"","frontmatter":{"title":"移动端页面加载时使用脚本自动跳转不会产生历史记录","categories":["学习笔记"],"tags":["HTML","移动端","网页浏览器"],"date":"2020-07-01 18:06:25"},"headers":[],"relativePath":"pages/posts/2020-07-01-automatic_redirect_without_history_when_loading_mobile_pages_with_script.md","path":"/home/runner/work/blog/blog/pages/posts/2020-07-01-automatic_redirect_without_history_when_loading_mobile_pages_with_script.md","lastUpdated":1733198069000}'),i=g(),r=a.frontmatter||{};return i.meta.frontmatter=Object.assign(i.meta.frontmatter||{},a.frontmatter||{}),u("pageData",a),u("valaxy:frontmatter",r),globalThis.$frontmatter=r,c({frontmatter:{title:"移动端页面加载时使用脚本自动跳转不会产生历史记录",categories:["学习笔记"],tags:["HTML","移动端","网页浏览器"],date:"2020-07-01 18:06:25"}}),(n,s)=>{const p=d;return f(),h(p,{frontmatter:m(r)},{"main-content-md":t(()=>s[0]||(s[0]=[l("p",null,"最近遇到这样一个需求：",-1),l("ul",null,[l("li",null,[l("p",null,[e("打开当前页面时，可能会带上一个参数"),l("code",null,"pid"),e("。")])]),l("li",null,[l("p",null,"页面初始化时，如果发现存在此参数，就立刻跳转到其对应的外部页面。")]),l("li",null,[l("p",null,"当用户从外部页面后退时，可以回到当前页面，此时正常显示页面内容。")])],-1),l("p",null,"我的实现方式是：",-1),l("ul",null,[l("li",null,[l("p",null,[e("用"),l("code",null,"hash"),e("传递"),l("code",null,"pid"),e("。")])]),l("li",null,[l("p",null,[e("在页面入口脚本中，如果"),l("code",null,"hash"),e("中没有"),l("code",null,"pid"),e("，就正常渲染页面。")])]),l("li",null,[l("p",null,[e("如果发现存在"),l("code",null,"pid"),e("，就不渲染页面内容，而是通过"),l("code",null,"ajax"),e("从后台获取"),l("code",null,"pid"),e("对应的URL。然后从"),l("code",null,"location.hash"),e("里去掉"),l("code",null,"pid"),e("，再修改"),l("code",null,"location.href"),e("进行跳转。")])])],-1),l("p",null,"在PC端Chrome下测试正常通过，但在手机浏览器中出现了问题。",-1),l("p",null,"跳转到新页面后，按后退时不会回到当前页。在微信浏览器里，后退会直接关闭，在小米自带浏览器、夸克浏览器里，后退会回到标签页的初始页，移动端Chrome还是正常。",-1),l("p",null,"上百度搜了下，尝试了以下方案，均无效：",-1),l("ul",null,[l("li",null,[e("加"),l("code",null,"setTimeout"),e("延时再跳转")]),l("li",null,[e("使用"),l("code",null,"location.assign()"),e("代替"),l("code",null,"location.href"),e("赋值")]),l("li",null,[e("使用"),l("code",null,"history.pushState"),e("手动写入当前页面URL后再跳转")]),l("li",null,[e("在"),l("code",null,"window.onload"),e("里执行判断并延时跳转")]),l("li",null,[e("在"),l("code",null,"window.onload"),e("里延时执行一个模拟点击事件并在该元素的点击回调中执行跳转")])],-1),l("p",null,"这其中倒是发现一个奇怪的现象，就是在延时跳转前，如果手动点击过页面任意位置，表现就会一切正常，新页面后退可以正常返回当前页，完全符合需求预期。",-1),l("p",null,[e("但是，使用"),l("code",null,"dispatchEvent"),e("模拟出来的点击事件不行。")],-1),l("p",null,[e("与之前做全屏api时遇到的问题类似，应该是浏览器有某种策略，要求"),l("code",null,"history"),e("的操作只能在用户的真实点击操作中执行。")],-1),l("p",null,"但奇怪的是搜了很多中文页，没有一个提到这样的问题。",-1),l("p",null,"最后在StackOverflow上找到了一些解答（类似问题同样很少，但总算有答案）：",-1),l("p",null,[l("a",{href:"https://html.spec.whatwg.org/multipage/history.html#location-object-setter-navigate",target:"_blank",rel:"noreferrer"},"HTML标准"),e(" 文档对"),l("code",null,"history"),e("的使用有一些规范：")],-1),l("blockquote",null,[l("p",null,"If any of the following conditions are met, let replacement flag be unset; otherwise, let it be set:"),l("ul",null,[l("li",null,[e("This "),l("code",null,"Location"),e(" object’s "),l("a",{href:"https://html.spec.whatwg.org/multipage/history.html#relevant-document",target:"_blank",rel:"noreferrer"},[e("relevant "),l("code",null,"Document")]),e(" has "),l("a",{href:"https://html.spec.whatwg.org/multipage/parsing.html#completely-loaded",target:"_blank",rel:"noreferrer"},"completely loaded"),e(", or")]),l("li",null,[e("In the "),l("a",{href:"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task",target:"_blank",rel:"noreferrer"},"task"),e(" in which the algorithm is running, an "),l("a",{href:"https://dom.spec.whatwg.org/#eventtarget-activation-behavior",target:"_blank",rel:"noreferrer"},"activation behavior"),e(" is currently being processed whose "),l("code",null,"click"),e(" event’s "),l("code",null,"isTrusted"),e(" attribute is true, or")]),l("li",null,[e("In the "),l("a",{href:"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task",target:"_blank",rel:"noreferrer"},"task"),e(" in which the algorithm is running, the event listener for a "),l("code",null,"click"),e(" event, whose "),l("code",null,"isTrusted"),e(" attribute is true, is being handled.")])])],-1),l("p",null,"大致的意思是：",-1),l("p",null,[e("如果满足以下任意条件之一， "),l("code",null,"location"),e("对象的"),l("code",null,"replacement"),e("标记置为默认，否则置为true。")],-1),l("p",null,[e("（换句话说，如果不满足以下条件，对"),l("code",null,"location"),e("进行任何操作，都不会产生新的历史记录）")],-1),l("ul",null,[l("li",null,[l("code",null,"location"),e("对象所在的文档已经"),l("code",null,"完全加载")]),l("li",null,[l("code",null,"location"),e("的修改操作由"),l("code",null,"click"),e("事件触发，且事件的"),l("code",null,"isTrusted"),e("属性为"),l("code",null,"true"),e("（也就是用户的真实点击操作）")])],-1),l("p",null,[e("英文不行，没有找到"),l("code",null,"完全加载"),e("的精确定义。但我推测对遵循HTML标准的浏览器来说，只有用户与页面产生互动，才表示页面真的已经“完全加载”了。")],-1),l("p",null,"在用户对页面进行操作前，只有最终展现的页面才被认为是有效页面，之前的所有中间跳转都应该被忽略，不计入历史记录，这样才能避免后退行为出现死锁。",-1),l("p",null,"我对这种设计表示理解，这段HTML标准的定义证实了我的推测。因此，原本预想的方案是走不通的，我只能调整需求了。",-1),l("p",null,"最终方案是增加一个跳转中间页，由用户点击来进行跳转。",-1),l("p",null,"话说Chrome没这个问题，说明Chrome在这一条上其实没有遵循HTML标准规范？",-1)])),"main-header":t(()=>[o(n.$slots,"main-header")]),"main-header-after":t(()=>[o(n.$slots,"main-header-after")]),"main-nav":t(()=>[o(n.$slots,"main-nav")]),"main-content":t(()=>[o(n.$slots,"main-content")]),"main-content-after":t(()=>[o(n.$slots,"main-content-after")]),"main-nav-before":t(()=>[o(n.$slots,"main-nav-before")]),"main-nav-after":t(()=>[o(n.$slots,"main-nav-after")]),comment:t(()=>[o(n.$slots,"comment")]),footer:t(()=>[o(n.$slots,"footer")]),aside:t(()=>[o(n.$slots,"aside")]),"aside-custom":t(()=>[o(n.$slots,"aside-custom")]),default:t(()=>[o(n.$slots,"default")]),_:3},8,["frontmatter"])}}};export{L as default};
