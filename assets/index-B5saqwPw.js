import{_ as m}from"./ValaxyMain.vue_vue_type_style_index_0_lang-BWN6FZjJ.js";import{f as u,w as e,e as y,A as h,ag as i,o as g,a as s,H as n,U as a}from"./app-O6veFoRw.js";import"./YunComment.vue_vue_type_style_index_0_lang-BdmCVZ97.js";import"./index-C5okkQwF.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-6OskRlK9.js";import"./post-CxZOEfth.js";const _="/assets/flow_nodejs_build-BcdaRSD4.png",L={__name:"index",setup(b,{expose:c}){const p=JSON.parse('{"title":"配置npmrc解决自动化部署时cypress等依赖安装问题","description":"","frontmatter":{"title":"配置npmrc解决自动化部署时cypress等依赖安装问题","categories":["学习笔记"],"tags":["npm","cypress","canvas","electron"],"date":"2024-05-05 22:02:19"},"headers":[{"level":3,"title":"创建.nvmrc文件","slug":"创建-nvmrc文件","link":"#创建-nvmrc文件","children":[]},{"level":3,"title":"创建.npmrc文件","slug":"创建-npmrc文件","link":"#创建-npmrc文件","children":[]},{"level":3,"title":"收工","slug":"收工","link":"#收工","children":[]}],"relativePath":"pages/posts/2024-05-08-configure_npmrc_to_solve_the_dependency_installation_issues_with_automated_deployment/index.md","path":"/home/runner/work/blog/blog/pages/posts/2024-05-08-configure_npmrc_to_solve_the_dependency_installation_issues_with_automated_deployment/index.md","lastUpdated":1733198069000}'),t=h(),r=p.frontmatter||{};return t.meta.frontmatter=Object.assign(t.meta.frontmatter||{},p.frontmatter||{}),i("pageData",p),i("valaxy:frontmatter",r),globalThis.$frontmatter=r,c({frontmatter:{title:"配置npmrc解决自动化部署时cypress等依赖安装问题",categories:["学习笔记"],tags:["npm","cypress","canvas","electron"],date:"2024-05-05 22:02:19"}}),(l,o)=>{const d=m;return g(),u(d,{frontmatter:y(r)},{"main-content-md":e(()=>o[0]||(o[0]=[s("p",null,"公司的代码仓库在阿里云的云效上，自动化部署使用的是云效的流水线Flow。",-1),s("p",null,"流水线默认提供的node版本最高是18，且默认的pnpm版本也较低。而现在的项目基本都是用pnpm作为包管理工具的。",-1),s("p",null,"如果编译环境不能做到一致，部署时就可能出现一些奇怪问题。",-1),s("p",null,"此外，构建主机在国内，安装依赖时也会遇到网络问题。",-1),s("p",null,[n("一般的依赖可以用镜像"),s("code",null,"npmmirror.com"),n("来解决(包括流水线自己默认的node镜像也是这样处理的)，但像cypress这种需要下载二进制文件的依赖，就没有办法了。")],-1),s("p",null,"比如，在流水线中执行安装依赖时，会报错：",-1),s("div",{class:"language- vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"[21:39:07] .../cypress@13.7.3/node_modules/cypress postinstall: Installing Cypress (version: 13.7.3)")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:07] .../cypress@13.7.3/node_modules/cypress postinstall: [STARTED] Task without title.")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED] The Cypress App could not be downloaded.")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED]")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED] Does your workplace require a proxy to be used to access the Internet? If so, you must configure the HTTP_PROXY environment variable before downloading Cypress. Read more: https://on.cypress.io/proxy-configuration")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED]")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED] Otherwise, please check network connectivity and try again:")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED]")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED] ----------")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED]")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED] URL: https://download.cypress.io/desktop/13.7.3?platform=linux&arch=x64")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED] AggregateError")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED]")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED] ----------")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED]")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED] Platform: linux-x64 (Ubuntu - 20.04)")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: [FAILED] Cypress Version: 13.7.3")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: The Cypress App could not be downloaded.")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: Does your workplace require a proxy to be used to access the Internet? If so, you must configure the HTTP_PROXY environment variable before downloading Cypress. Read more: https://on.cypress.io/proxy-configuration")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: Otherwise, please check network connectivity and try again:")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: ----------")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: URL: https://download.cypress.io/desktop/13.7.3?platform=linux&arch=x64")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: AggregateError")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: ----------")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: Platform: linux-x64 (Ubuntu - 20.04)")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: Cypress Version: 13.7.3")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09] .../cypress@13.7.3/node_modules/cypress postinstall: Failed")]),n(`
`),s("span",{class:"line"},[s("span",null,"[21:39:09]  ELIFECYCLE  Command failed with exit code 1.")])])]),s("button",{class:"collapse"})],-1),s("p",null,"明显就是网络不通导致的。",-1),s("p",null,[n("可以通过配置"),s("code",null,".npmrc"),n("与"),s("code",null,".nvmrc"),n("来解决开发环境与部署编译环境的一致性问题。")],-1),s("h3",{id:"创建-nvmrc文件",tabindex:"-1"},[n("创建"),s("code",null,".nvmrc"),n("文件 "),s("a",{class:"header-anchor",href:"#创建-nvmrc文件","aria-label":'Permalink to "创建`.nvmrc`文件"'},"​")],-1),s("p",null,[n("首先需要使用"),s("code",null,".nvmrc"),n("来指定nodejs版本。")],-1),s("p",null,[n("新建"),s("code",null,".nvmrc"),n("文件，输入以下内容保存(我的开发环境node版本是"),s("code",null,"20.11.1"),n("，按需修改)。")],-1),s("div",{class:"language- vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"v20.11.1")])])]),s("button",{class:"collapse"})],-1),s("p",null,[n("然后在云效流水线的"),s("code",null,"Node.js构建"),n("中选择"),s("code",null,"使用代码库中.nvmrc文件中的版本")],-1),s("figure",null,[s("img",{src:_,alt:"",loading:"lazy",decoding:"async"})],-1),s("h3",{id:"创建-npmrc文件",tabindex:"-1"},[n("创建"),s("code",null,".npmrc"),n("文件 "),s("a",{class:"header-anchor",href:"#创建-npmrc文件","aria-label":'Permalink to "创建`.npmrc`文件"'},"​")],-1),s("p",null,[n("在项目根目录下新建"),s("code",null,".npmrc"),n("文件，输入以下内容保存：")],-1),s("div",{class:"language- vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"shamefully-hoist=true")]),n(`
`),s("span",{class:"line"},[s("span",null,"strict-peer-dependencies=false")]),n(`
`),s("span",{class:"line"},[s("span",null,"registry=https://registry.npmmirror.com")]),n(`
`),s("span",{class:"line"},[s("span",null,"disturl=https://registry.npmmirror.com/-/binary/node/")]),n(`
`),s("span",{class:"line"},[s("span",null,"# node-sass预编译二进制文件下载地址")]),n(`
`),s("span",{class:"line"},[s("span",null,"sass_binary_site=https://registry.npmmirror.com/-/binary/node-sass")]),n(`
`),s("span",{class:"line"},[s("span",null,"# sharp预编译共享库, 截止2022-09-20 sharp@0.31.0的预编译共享库并未同步到镜像, 入安装失败可切换到sharp@0.30.7使用")]),n(`
`),s("span",{class:"line"},[s("span",null,"sharp_libvips_binary_host=https://registry.npmmirror.com/-/binary/sharp-libvips")]),n(`
`),s("span",{class:"line"},[s("span",null,"python_mirror=https://registry.npmmirror.com/-/binary/python/")]),n(`
`),s("span",{class:"line"},[s("span",null,"electron_mirror=https://registry.npmmirror.com/-/binary/electron/")]),n(`
`),s("span",{class:"line"},[s("span",null,"electron_builder_binaries_mirror=https://registry.npmmirror.com/-/binary/electron-builder-binaries/")]),n(`
`),s("span",{class:"line"},[s("span",null,"# 无特殊配置参考{pkg-name}_binary_host_mirror={mirror}")]),n(`
`),s("span",{class:"line"},[s("span",null,"canvas_binary_host_mirror=https://registry.npmmirror.com/-/binary/canvas")]),n(`
`),s("span",{class:"line"},[s("span",null,"node_sqlite3_binary_host_mirror=https://registry.npmmirror.com/-/binary/sqlite3")]),n(`
`),s("span",{class:"line"},[s("span",null,"better_sqlite3_binary_host_mirror=https://registry.npmmirror.com/-/binary/better-sqlite3")]),n(`
`),s("span",{class:"line"},[s("span",null,"# cypress配置")]),n(`
`),s("span",{class:"line"},[s("span",null,"CYPRESS_DOWNLOAD_PATH_TEMPLATE=https://registry.npmmirror.com/-/binary/cypress/\\${version}/\\${platform}-\\${arch}/cypress.zip")])])]),s("button",{class:"collapse"})],-1),s("p",null,"下面粗略解释下作用。",-1),s("div",{class:"language- vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"shamefully-hoist=true")]),n(`
`),s("span",{class:"line"},[s("span",null,"strict-peer-dependencies=false")])])]),s("button",{class:"collapse"})],-1),s("p",null,"最开头这一段主要是给pnpm使用的。",-1),s("p",null,"因为pnpm默认不会将依赖的依赖安装到node_modules目录下，而有些npm时代的项目会省略掉一些依赖的依赖的package声明，如果改用pnpm就会出问题。",-1),s("div",{class:"language- vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"registry=https://registry.npmmirror.com")]),n(`
`),s("span",{class:"line"},[s("span",null,"disturl=https://registry.npmmirror.com/-/binary/node/")])])]),s("button",{class:"collapse"})],-1),s("p",null,"这一段用于改写默认镜像地址，应该是很常见的配置了。",-1),s("p",null,"之后的配置都是用于改写二进制文件的下载地址的，列举了一些常见的二进制依赖，来自其他网站。",-1),s("div",{class:"language- vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"# cypress配置")]),n(`
`),s("span",{class:"line"},[s("span",null,"# CYPRESS_DOWNLOAD_MIRROR=https://registry.npmmirror.com/-/binary/cypress")]),n(`
`),s("span",{class:"line"},[s("span",null,"# 不能使用前者，因为desktop路径仍然会被保留")]),n(`
`),s("span",{class:"line"},[s("span",null,"CYPRESS_DOWNLOAD_PATH_TEMPLATE=https://registry.npmmirror.com/-/binary/cypress/\\${version}/\\${platform}-\\${arch}/cypress.zip")])])]),s("button",{class:"collapse"})],-1),s("p",null,[n("最后的cypress配置是我额外加的，因为它的二进制文件下载地址与"),s("code",null,"npmmirror.com"),n("的镜像地址不一致，所以需要单独配置。")],-1),s("p",null,"参考来源：",-1),s("p",null,[s("a",{href:"https://docs.cypress.io/guides/references/advanced-installation#Download-path-template",target:"_blank",rel:"noreferrer"},"https://docs.cypress.io/guides/references/advanced-installation#Download-path-template")],-1),s("h3",{id:"收工",tabindex:"-1"},[n("收工 "),s("a",{class:"header-anchor",href:"#收工","aria-label":'Permalink to "收工"'},"​")],-1),s("p",null,"最后将这两个文件加入版本控制并提交到发布用的分支即可。",-1),s("p",null,"在编译流水线中执行编译命令，比如我的：",-1),s("div",{class:"language- vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code"},[s("code",{"v-pre":""},[s("span",{class:"line"},[s("span",null,"npm i -g pnpm@9.0.6")]),n(`
`),s("span",{class:"line"},[s("span",null,"pnpm config set registry https://registry.npmmirror.com")]),n(`
`),s("span",{class:"line"},[s("span",null,"pnpm i")]),n(`
`),s("span",{class:"line"},[s("span",null,"pnpm run build")])])]),s("button",{class:"collapse"})],-1)])),"main-header":e(()=>[a(l.$slots,"main-header")]),"main-header-after":e(()=>[a(l.$slots,"main-header-after")]),"main-nav":e(()=>[a(l.$slots,"main-nav")]),"main-content":e(()=>[a(l.$slots,"main-content")]),"main-content-after":e(()=>[a(l.$slots,"main-content-after")]),"main-nav-before":e(()=>[a(l.$slots,"main-nav-before")]),"main-nav-after":e(()=>[a(l.$slots,"main-nav-after")]),comment:e(()=>[a(l.$slots,"comment")]),footer:e(()=>[a(l.$slots,"footer")]),aside:e(()=>[a(l.$slots,"aside")]),"aside-custom":e(()=>[a(l.$slots,"aside-custom")]),default:e(()=>[a(l.$slots,"default")]),_:3},8,["frontmatter"])}}};export{L as default};
